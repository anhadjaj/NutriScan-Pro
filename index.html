<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriScan Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #00aaff;
            --secondary-color: #0077cc;
            --background-start: #0f2027;
            --background-end: #2c5364;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-color: #e0eafc;
            --border-color: rgba(255, 255, 255, 0.2);
            --recommend-yes-bg: rgba(16, 185, 129, 0.1);
            --recommend-yes-text: #10B981;
            --recommend-no-bg: rgba(239, 68, 68, 0.1);
            --recommend-no-text: #EF4444;
        }

        body { 
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            color: var(--text-color);
        }

        .info-card { 
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 1.5rem;
        }

        .styled-btn {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 170, 255, 0.2);
        }

        .styled-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 170, 255, 0.4);
        }
         .styled-btn:disabled {
            background-color: #4A5568;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .secondary-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
        }
        .secondary-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: var(--primary-color);
        }
        
        .delete-btn {
            background: transparent;
            color: #718096;
            transition: color 0.2s ease;
        }
        .delete-btn:hover {
            color: #ef4444;
        }


        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-7xl">
        <div class="text-center mb-6">
            <h1 class="text-4xl lg:text-5xl font-bold text-white flex items-center justify-center"><i class="fas fa-utensils mr-4 opacity-80"></i>NutriScan Pro</h1>
            <p class="text-gray-400 mt-2">Your AI-powered visual diet tracker.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: Camera and Results -->
            <div class="flex flex-col gap-6">
                <div class="info-card aspect-video flex items-center justify-center overflow-hidden">
                    <video id="webcam" autoplay playsinline class="w-full h-full object-cover"></video>
                </div>
                <button id="scan-btn" class="styled-btn w-full flex items-center justify-center gap-2">
                    <i class="fas fa-camera"></i>
                    <span>Scan Food</span>
                </button>

                <div id="result-card" class="info-card p-5 hidden">
                    <div id="loader" class="flex justify-center items-center h-24 hidden">
                        <div class="loader"></div>
                    </div>
                    <div id="result-content">
                        <h3 class="text-xl font-bold text-white">Identified: <span id="food-name" class="text-primary-color"></span></h3>
                        <p id="serving-size-info" class="text-xs text-gray-400 text-center -mt-1 mb-2"></p>
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mt-4 text-center">
                            <div><p class="text-gray-400">Calories</p><p id="calories" class="text-2xl font-bold"></p></div>
                            <div><p class="text-gray-400">Protein</p><p id="protein" class="text-2xl font-bold"></p></div>
                            <div><p class="text-gray-400">Carbs</p><p id="carbs" class="text-2xl font-bold"></p></div>
                            <div><p class="text-gray-400">Fats</p><p id="fats" class="text-2xl font-bold"></p></div>
                            <div><p class="text-gray-400">Sugar</p><p id="sugar" class="text-2xl font-bold"></p></div>
                        </div>
                        <p id="added-sugar-info" class="text-xs text-gray-400 text-center mt-2"></p>
                        
                        <!-- Recommendation Section -->
                        <div id="recommendation-section" class="mt-5 p-4 rounded-xl">
                            <h4 class="font-bold text-lg mb-1 flex items-center gap-2">
                                <span id="recommendation-icon"></span>
                                <span id="recommendation-text"></span>
                            </h4>
                            <p id="recommendation-reason" class="text-sm text-gray-300"></p>
                        </div>
                        
                        <div id="quantity-piece-controls" class="flex items-center justify-center gap-4 mt-5">
                            <label for="quantity_piece" class="font-semibold">Quantity:</label>
                             <button id="qty-minus" class="styled-btn secondary-btn px-4 py-2 rounded-lg">-</button>
                             <input type="number" id="quantity_piece" value="1" min="1" class="w-20 bg-transparent border border-gray-600 rounded-lg text-center font-bold text-lg">
                             <button id="qty-plus" class="styled-btn secondary-btn px-4 py-2 rounded-lg">+</button>
                        </div>

                        <div id="quantity-gram-controls" class="flex items-center justify-center gap-4 mt-5 hidden">
                            <label for="quantity_grams" class="font-semibold">Weight:</label>
                             <input type="number" id="quantity_grams" value="100" min="1" class="w-24 bg-transparent border border-gray-600 rounded-lg text-center font-bold text-lg">
                             <span class="font-semibold">grams</span>
                        </div>

                        <button id="add-btn" class="styled-btn w-full mt-5">Add to Daily Log</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Totals and Log -->
            <div class="flex flex-col gap-6">
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="info-card p-4 text-center">
                        <p class="text-gray-400">Total Calories</p>
                        <p id="total-calories" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="info-card p-4 text-center">
                        <p class="text-gray-400">Total Protein</p>
                        <p id="total-protein" class="text-3xl font-bold">0 g</p>
                    </div>
                     <div class="info-card p-4 text-center">
                        <p class="text-gray-400">Total Carbs</p>
                        <p id="total-carbs" class="text-3xl font-bold">0 g</p>
                    </div>
                    <div class="info-card p-4 text-center">
                        <p class="text-gray-400">Total Fats</p>
                        <p id="total-fats" class="text-3xl font-bold">0 g</p>
                    </div>
                     <div class="info-card p-4 text-center lg:col-span-1">
                        <p class="text-gray-400">Total Sugar</p>
                        <p id="total-sugar" class="text-3xl font-bold">0 g</p>
                    </div>
                </div>
                <div class="info-card p-5 flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">Today's Log</h3>
                        <div id="user-id-display" class="text-xs text-gray-500">Initializing...</div>
                    </div>
                    <div class="hidden sm:grid grid-cols-8 gap-2 text-xs font-semibold text-gray-400 border-b border-gray-700 pb-2 mb-2">
                        <span class="col-span-2">Food</span>
                        <span class="text-center">Time</span>
                        <span class="text-center">Qty</span>
                        <span class="text-right">Calories</span>
                        <span class="text-right">Protein</span>
                        <span class="text-right">Sugar</span>
                        <span class="text-right"></span>
                    </div>
                    <div id="log-container" class="flex-grow overflow-y-auto pr-2">
                        <p id="empty-log-msg" class="text-gray-500 text-center mt-8">Your log is empty. Scan a food item to get started!</p>
                    </div>
                    <button id="reset-btn" class="styled-btn secondary-btn w-full mt-4">Reset Today's Log</button>
                </div>
            </div>
        </div>
    </div>
    <canvas id="capture-canvas" class="hidden"></canvas>

<script type="module">
    // Firebase Imports
    import { initializeApp as initializeFirebaseApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, Timestamp, getDocs, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- YOUR FIREBASE AND GEMINI KEYS ---
    const userFirebaseConfig = {
      apiKey: "AIzaSyAXevkelXF3QUko9S79Mix3lpK5J9RXnls",
      authDomain: "nutriscanpro-82216.firebaseapp.com",
      projectId: "nutriscanpro-82216",
      storageBucket: "nutriscanpro-82216.appspot.com",
      messagingSenderId: "637094147576",
      appId: "1:637094147576:web:ecb5cd5b7d3abe7544d20d",
      measurementId: "G-98QEXEX89S"
    };
    const GEMINI_API_KEY = "AIzaSyDV-WvEe_yn-aLcSTnTsViGXN28tnTVHmA";
    // ------------------------------------

    // DOM Elements
    const videoElement = document.getElementById('webcam');
    const scanBtn = document.getElementById('scan-btn');
    const addBtn = document.getElementById('add-btn');
    const resetBtn = document.getElementById('reset-btn');
    const resultCard = document.getElementById('result-card');
    const loader = document.getElementById('loader');
    const resultContent = document.getElementById('result-content');
    const logContainer = document.getElementById('log-container');
    const captureCanvas = document.getElementById('capture-canvas');
    const quantityPieceInput = document.getElementById('quantity_piece');
    const quantityGramInput = document.getElementById('quantity_grams');
    const qtyMinusBtn = document.getElementById('qty-minus');
    const qtyPlusBtn = document.getElementById('qty-plus');
    const emptyLogMsg = document.getElementById('empty-log-msg');
    const userIdDisplay = document.getElementById('user-id-display');
    const servingSizeInfo = document.getElementById('serving-size-info');
    const quantityPieceControls = document.getElementById('quantity-piece-controls');
    const quantityGramControls = document.getElementById('quantity-gram-controls');
    const recommendationSection = document.getElementById('recommendation-section');

    // State Variables
    let currentScanResult = null;
    let db, auth, userId, appId;
    let unsubscribeLog; 
    let firebaseEnabled = false;
    let localDailyLog = [];

    // --- App Initialization ---
    async function initializeNutriScanApp() {
        startCamera();
        scanBtn.disabled = true;
        resetBtn.disabled = true;

        try {
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let firebaseConfig;
            let isCanvasEnv = false;

            if (typeof __firebase_config !== 'undefined' && __firebase_config.startsWith('{')) {
                firebaseConfig = JSON.parse(__firebase_config);
                firebaseEnabled = true;
                isCanvasEnv = true;
            } else if (userFirebaseConfig && userFirebaseConfig.apiKey && !userFirebaseConfig.apiKey.includes("PASTE")) {
                firebaseConfig = userFirebaseConfig;
                firebaseEnabled = true;
            } else {
                throw new Error("Firebase config not available. Running in local mode.");
            }

            const app = initializeFirebaseApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`;
                    scanBtn.disabled = false;
                    resetBtn.disabled = false;
                    listenToLog();
                } else {
                    if (unsubscribeLog) unsubscribeLog();
                    userIdDisplay.textContent = "Not Signed In";
                }
            });
            
            if (isCanvasEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                 await signInAnonymously(auth);
            }


        } catch (e) {
            console.warn(e.message);
            userIdDisplay.textContent = "Local Mode (Using Browser Storage)";
            scanBtn.disabled = false;
            resetBtn.disabled = false;
            loadLocalLog();
        }
    }

    // --- Gemini API Call ---
    async function getFoodDataFromImage(base64Image) {
        let apiKey = "";

        if (typeof __gemini_api_key__ !== 'undefined' && __gemini_api_key__) {
             apiKey = __gemini_api_key__;
        } else {
             apiKey = GEMINI_API_KEY;
        }
        
        const fallbackResponse = { food_name: "Error", quantity_estimation: 1, calories: 0, protein: 0, carbs: 0, fats: 0, sugar: 0, added_sugars: "N/A", serving_unit: 'N/A', recommendation: "Neutral", reason: "Could not analyze the food item." };

        if (!apiKey || apiKey.includes("PASTE")) {
            alert("Gemini API Key is not configured. Please add your key to the script.");
            return fallbackResponse;
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [
                { text: "Perform a deep search for the food item in the image, trying to identify brand and product names for accuracy. First, determine if the item is typically counted in pieces or measured by weight, and set 'serving_unit' to 'per piece' or 'per 100g'. Provide a nutritional estimate for that single serving unit, including calories, protein, carbs, fats, and total sugar. Crucially, provide the 'ADDED SUGARS' content as a string (e.g., '15g' or 'N/A'). Also, estimate the quantity of items. Based on its nutritional profile (especially added sugar and fats), provide a simple 'Yes' or 'No' recommendation on whether one should consume it as part of a healthy diet, and a brief, one-sentence reason. If you cannot identify a food item, respond with 'Unknown' for food_name and 0 for all nutritional values." },
                { inlineData: { mimeType: "image/jpeg", data: base64Image } }
            ] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: { type: "OBJECT", properties: { "food_name": { "type": "STRING" }, "quantity_estimation": { "type": "NUMBER" }, "calories": { "type": "NUMBER" }, "protein": { "type": "NUMBER" }, "carbs": { "type": "NUMBER" }, "fats": { "type": "NUMBER" }, "sugar": { "type": "NUMBER" }, "added_sugars": { "type": "STRING" }, "serving_unit": { "type": "STRING" }, "recommendation": { "type": "STRING" }, "reason": { "type": "STRING" } }, required: ["food_name", "quantity_estimation", "calories", "protein", "carbs", "fats", "sugar", "added_sugars", "serving_unit", "recommendation", "reason"] }
            }
        };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API call failed: ${response.status}`);
            const result = await response.json();
            if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                throw new Error("Invalid API response structure");
            }
            const jsonText = result.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText);
        } catch (error)
        {
            console.error("Gemini API Error:", error);
            return fallbackResponse;
        }
    }


    // --- Core Functions ---
    async function startCamera() {
        const videoConstraints = {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'environment'
        };
        try {
            let stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints });
            videoElement.srcObject = stream;
        } catch (error) {
            console.warn("Could not get back camera, trying front camera.", error);
            try {
                let stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
            } catch (fallbackError) {
                console.error("Error accessing any webcam:", fallbackError);
                 alert("Could not access any camera. Please ensure you have given permission.");
            }
        }
    }
    
    async function scanFood() {
        scanBtn.disabled = true;
        scanBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>Scanning...</span>`;
        resultCard.classList.remove('hidden');
        loader.classList.remove('hidden');
        resultContent.classList.add('hidden');

        try {
            captureCanvas.width = videoElement.videoWidth;
            captureCanvas.height = videoElement.videoHeight;
            const context = captureCanvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, captureCanvas.width, captureCanvas.height);
            
            const base64Image = captureCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            
            const foodData = await getFoodDataFromImage(base64Image);
            
            loader.classList.add('hidden');

            if (foodData && foodData.food_name !== "Unknown" && foodData.food_name !== "Error") {
                currentScanResult = foodData;
                document.getElementById('food-name').textContent = foodData.food_name;
                document.getElementById('calories').textContent = foodData.calories.toFixed(0);
                document.getElementById('protein').textContent = `${foodData.protein.toFixed(1)}g`;
                document.getElementById('carbs').textContent = `${foodData.carbs.toFixed(1)}g`;
                document.getElementById('fats').textContent = `${foodData.fats.toFixed(1)}g`;
                document.getElementById('sugar').textContent = `${foodData.sugar.toFixed(1)}g`;
                
                document.getElementById('added-sugar-info').textContent = foodData.added_sugars !== 'N/A' ? `Includes ${foodData.added_sugars} of added sugars.` : '';

                // Update recommendation UI
                const recText = document.getElementById('recommendation-text');
                const recReason = document.getElementById('recommendation-reason');
                const recIcon = document.getElementById('recommendation-icon');
                
                if (foodData.recommendation.toLowerCase() === 'yes') {
                    recommendationSection.style.background = 'var(--recommend-yes-bg)';
                    recText.style.color = 'var(--recommend-yes-text)';
                    recText.textContent = 'Recommendation: Yes';
                    recIcon.innerHTML = `<i class="fas fa-check-circle" style="color: var(--recommend-yes-text);"></i>`;
                } else {
                    recommendationSection.style.background = 'var(--recommend-no-bg)';
                    recText.style.color = 'var(--recommend-no-text)';
                    recText.textContent = 'Recommendation: No';
                    recIcon.innerHTML = `<i class="fas fa-times-circle" style="color: var(--recommend-no-text);"></i>`;
                }
                recReason.textContent = foodData.reason;


                if (foodData.serving_unit === 'per piece') {
                    quantityPieceControls.classList.remove('hidden');
                    quantityGramControls.classList.add('hidden');
                    quantityPieceInput.value = foodData.quantity_estimation || 1;
                } else {
                    quantityGramControls.classList.remove('hidden');
                    quantityPieceControls.classList.add('hidden');
                    quantityGramInput.value = 100;
                }
                servingSizeInfo.textContent = `Nutritional values are ${foodData.serving_unit || 'per serving'}.`;
                resultContent.classList.remove('hidden');
            } else {
                 document.getElementById('food-name').textContent = foodData.food_name === "Error" ? "Scan Error" : "Food not recognized";
                document.getElementById('calories').textContent = '0';
                document.getElementById('protein').textContent = '0g';
                document.getElementById('carbs').textContent = '0g';
                document.getElementById('fats').textContent = '0g';
                document.getElementById('sugar').textContent = '0g';
                document.getElementById('added-sugar-info').textContent = '';
                recommendationSection.style.background = 'transparent';
                document.getElementById('recommendation-text').textContent = '';
                document.getElementById('recommendation-reason').textContent = 'Could not analyze item.';
                document.getElementById('recommendation-icon').innerHTML = '';
                quantityPieceControls.classList.remove('hidden');
                quantityGramControls.classList.add('hidden');
                quantityPieceInput.value = 1;
                servingSizeInfo.textContent = '';
                resultContent.classList.remove('hidden');
                currentScanResult = null;
            }
        } catch(e) {
            console.error("Error during scan process:", e);
        } finally {
            scanBtn.disabled = false;
            scanBtn.innerHTML = `<i class="fas fa-camera"></i><span>Scan Food</span>`;
        }
    }

    // --- Universal Log Functions ---
    async function addToLog() {
        if (!currentScanResult) return;
        
        addBtn.disabled = true;
        addBtn.textContent = "Adding...";
        
        try {
            let quantity, unit, finalCalories, finalProtein, finalCarbs, finalFats, finalSugar;

            if (currentScanResult.serving_unit === 'per piece') {
                quantity = parseInt(quantityPieceInput.value);
                unit = 'pcs';
                if (isNaN(quantity) || quantity < 1) {
                     alert("Please enter a valid quantity.");
                     return; 
                }
                const ratio = quantity;
                finalCalories = currentScanResult.calories * ratio;
                finalProtein = currentScanResult.protein * ratio;
                finalCarbs = currentScanResult.carbs * ratio;
                finalFats = currentScanResult.fats * ratio;
                finalSugar = currentScanResult.sugar * ratio;
            } else { // per 100g
                quantity = parseInt(quantityGramInput.value);
                unit = 'g';
                if (isNaN(quantity) || quantity < 1) {
                    alert("Please enter a valid weight in grams.");
                    return;
                }
                const ratio = quantity / 100.0;
                finalCalories = currentScanResult.calories * ratio;
                finalProtein = currentScanResult.protein * ratio;
                finalCarbs = currentScanResult.carbs * ratio;
                finalFats = currentScanResult.fats * ratio;
                finalSugar = currentScanResult.sugar * ratio;
            }

            const logEntry = {
                id: `local_${Date.now()}`,
                name: currentScanResult.food_name,
                quantity: quantity,
                unit: unit,
                calories: finalCalories,
                protein: finalProtein,
                carbs: finalCarbs,
                fats: finalFats,
                sugar: finalSugar,
                timestamp: new Date()
            };

            if (firebaseEnabled && userId) {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/nutritionLog`), { ...logEntry, timestamp: serverTimestamp() });
            } else {
                localDailyLog.push(logEntry);
                saveLocalLog();
                updateLogUI(localDailyLog);
            }

            resultCard.classList.add('hidden');
            currentScanResult = null;
        } catch (e) {
            console.error("Error in addToLog:", e);
        } finally {
            addBtn.disabled = false;
            addBtn.textContent = "Add to Daily Log";
        }
    }
    
    async function deleteLogItem(docId) {
        if (firebaseEnabled && userId) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/nutritionLog`, docId));
            } catch (e) { console.error("Error deleting item:", e); }
        } else {
            localDailyLog = localDailyLog.filter(item => item.id !== docId);
            saveLocalLog();
            updateLogUI(localDailyLog);
        }
    }
    
    async function resetDay() {
        if (confirm("Are you sure you want to reset your log for today? This cannot be undone.")) {
            if (firebaseEnabled && userId) {
                resetBtn.disabled = true;
                resetBtn.textContent = "Resetting...";
                try {
                    const startOfToday = new Date();
                    startOfToday.setHours(0, 0, 0, 0);
                    const startOfTodayTimestamp = Timestamp.fromDate(startOfToday);
                    const logCollection = collection(db, `artifacts/${appId}/users/${userId}/nutritionLog`);
                    const q = query(logCollection, where("timestamp", ">=", startOfTodayTimestamp));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();
                } catch (e) { console.error("Error resetting log: ", e);
                } finally {
                    resetBtn.disabled = false;
                    resetBtn.textContent = "Reset Today's Log";
                }
            } else {
                localDailyLog = [];
                saveLocalLog();
                updateLogUI(localDailyLog);
            }
        }
    }

    // --- Firestore-Specific Functions ---
    function listenToLog() {
        if (!userId || !firebaseEnabled) return;
        if (unsubscribeLog) unsubscribeLog();
        
        const startOfToday = new Date();
        startOfToday.setHours(0, 0, 0, 0);
        const startOfTodayTimestamp = Timestamp.fromDate(startOfToday);

        const logCollection = collection(db, `artifacts/${appId}/users/${userId}/nutritionLog`);
        const q = query(logCollection, where("timestamp", ">=", startOfTodayTimestamp));

        unsubscribeLog = onSnapshot(q, (snapshot) => {
            const dailyLog = [];
            snapshot.forEach(doc => {
                dailyLog.push({ id: doc.id, ...doc.data() });
            });
            dailyLog.sort((a, b) => a.timestamp?.seconds - b.timestamp?.seconds);
            updateLogUI(dailyLog);
        });
    }
    
    // --- Local Storage Functions ---
    function saveLocalLog() {
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(`nutriScanLog_${today}`, JSON.stringify(localDailyLog));
    }

    function loadLocalLog() {
        const today = new Date().toISOString().split('T')[0];
        const savedLog = localStorage.getItem(`nutriScanLog_${today}`);
        if (savedLog) {
            localDailyLog = JSON.parse(savedLog);
            updateLogUI(localDailyLog);
        }
    }


    // --- UI Update Function ---
    function updateLogUI(logData) {
        let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0, totalSugar = 0;
        logContainer.innerHTML = '';
        
        emptyLogMsg.classList.toggle('hidden', logData.length > 0);

        logData.forEach(item => {
            totalCalories += item.calories;
            totalProtein += item.protein;
            totalCarbs += item.carbs;
            totalFats += item.fats;
            totalSugar += item.sugar || 0; // Add sugar, default to 0 if not present
            
            const itemTime = item.timestamp ? new Date(item.timestamp.seconds ? item.timestamp.seconds * 1000 : item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
            const itemUnit = item.unit || 'pcs';

            const logItem = document.createElement('div');
            logItem.className = 'grid grid-cols-4 sm:grid-cols-8 gap-2 text-sm py-2 border-b border-gray-700 items-center';
            logItem.innerHTML = `
                <span class="col-span-4 sm:col-span-2 font-semibold capitalize">${item.name}</span>
                <span class="hidden sm:inline-block text-center text-gray-400">${itemTime}</span>
                <span class="hidden sm:inline-block text-center">${item.quantity} ${itemUnit}</span>
                <span class="hidden sm:inline-block text-right">${item.calories.toFixed(0)} kcal</span>
                <span class="hidden sm:inline-block text-right">${item.protein.toFixed(1)} g</span>
                <span class="hidden sm:inline-block text-right">${(item.sugar || 0).toFixed(1)} g</span>
                <span class="text-right"><button data-id="${item.id}" class="delete-btn"><i class="fas fa-trash-alt"></i></button></span>
            `;
            logContainer.appendChild(logItem);
        });
        
        logContainer.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteLogItem(btn.dataset.id));
        });

        document.getElementById('total-calories').textContent = totalCalories.toFixed(0);
        document.getElementById('total-protein').textContent = `${totalProtein.toFixed(1)} g`;
        document.getElementById('total-carbs').textContent = `${totalCarbs.toFixed(1)} g`;
        document.getElementById('total-fats').textContent = `${totalFats.toFixed(1)} g`;
        document.getElementById('total-sugar').textContent = `${totalSugar.toFixed(1)} g`;
    }

    // --- Event Listeners ---
    scanBtn.addEventListener('click', scanFood);
    addBtn.addEventListener('click', addToLog);
    resetBtn.addEventListener('click', resetDay);
    
    qtyMinusBtn.addEventListener('click', () => {
        let currentQty = parseInt(quantityPieceInput.value);
        if (currentQty > 1) quantityPieceInput.value = currentQty - 1;
    });

    qtyPlusBtn.addEventListener('click', () => {
        let currentQty = parseInt(quantityPieceInput.value);
        quantityPieceInput.value = currentQty + 1;
    });
    
    // --- Initialize App ---
    initializeNutriScanApp();

</script>
</body>
</html>
